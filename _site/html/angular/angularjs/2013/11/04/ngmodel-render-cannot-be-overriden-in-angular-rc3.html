<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Why ngModel's $render function can't be overriden in AngularJS rc3?</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Ivan's toy</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>Why ngModel's $render function can't be overriden in AngularJS rc3?</h2>
<p class="meta">04 Nov 2013</p>

<div class="post">
<h1>$render</h1>

<p>The other day I asked a team member to introduce <a href="https://github.com/angular-ui/ui-tinymce">ui-tinymce</a> into our project. A half day later, he told me that it didn&#39;t work with Angular rc3 while rc2 was ok. He found some guy reported the same <a href="https://github.com/angular/angular.js/issues/4560">issue</a> and got a workaround from <a href="https://github.com/angular-ui/ui-tinymce/issues/49">another thread</a> which was not a decent fix.</p>

<p>The issue is all about $render function isn&#39;t called when model is actually changed. No content can be set into tinymce.</p>

<div class="highlight"><pre><code class="javascript"><span class="k">return</span> <span class="p">{</span>
    <span class="nx">require</span><span class="o">:</span> <span class="s1">&#39;ngModel&#39;</span><span class="p">,</span>
    <span class="p">..........</span>
    <span class="nx">ngModel</span><span class="p">.</span><span class="nx">$render</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">tinyInstance</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tinyInstance</span> <span class="o">=</span> <span class="nx">tinymce</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">tinyInstance</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tinyInstance</span><span class="p">.</span><span class="nx">setContent</span><span class="p">(</span><span class="nx">ngModel</span><span class="p">.</span><span class="nx">$viewValue</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>

<p>What this library did is very common if you want to wrap a 3rd party library into Angular. $render is what you need to set the value back into the 3rd party widget given any change. But this function never gets called if using Angular rc3!</p>

<p>I got some time to look into this issue today. I dived into Angular&#39;s source and found what it documents about <em>$render</em>.</p>

<div class="highlight"><pre><code class="javascript"> <span class="cm">/**</span>
<span class="cm">   * @ngdoc function</span>
<span class="cm">   * @name ng.directive:ngModel.NgModelController#$render</span>
<span class="cm">   * @methodOf ng.directive:ngModel.NgModelController</span>
<span class="cm">   *</span>
<span class="cm">   * @description</span>
<span class="cm">   * Called when the view needs to be updated. It is expected that the user of the ng-model</span>
<span class="cm">   * directive will implement this method.</span>
<span class="cm">   */</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">$render</span> <span class="o">=</span> <span class="nx">noop</span><span class="p">;</span>
</code></pre></div>
  

<p>It is empty by default and should be implemented by the user. That&#39;s what the author of the ui-tinymce did so far. It is supposed to be working. To diagnose this issue, I decided to find where this function is called by Angular. It&#39;s still in NgModelController a few lines below the defination of $render.</p>

<div class="highlight"><pre><code class="javascript"><span class="c1">// model -&gt; value</span>
<span class="kd">var</span> <span class="nx">ctrl</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

<span class="nx">$scope</span><span class="p">.</span><span class="nx">$watch</span><span class="p">(</span><span class="kd">function</span> <span class="nx">ngModelWatch</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">ngModelGet</span><span class="p">(</span><span class="nx">$scope</span><span class="p">);</span>

<span class="c1">// if scope model value and ngModel value are out of sync</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">$modelValue</span> <span class="o">!==</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">formatters</span> <span class="o">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">$formatters</span><span class="p">,</span>
      <span class="nx">idx</span> <span class="o">=</span> <span class="nx">formatters</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

  <span class="nx">ctrl</span><span class="p">.</span><span class="nx">$modelValue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nx">formatters</span><span class="p">[</span><span class="nx">idx</span><span class="p">](</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">$viewValue</span> <span class="o">!==</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">ctrl</span><span class="p">.</span><span class="nx">$viewValue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="c1">// IW added: This is where ngModel Ctrl call the $render</span>
    <span class="c1">// console.log(&quot;$render is called in the watch&quot;);</span>
    <span class="nx">ctrl</span><span class="p">.</span><span class="nx">$render</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
 

<p>Check the bottom line, if the value changes, $render is called. I put some log right below where I added the comment. I also added some log when $render is called in ui-tinymce. The former works as expected but the latter never gets called. Obviously, the actual $render is not the one defined in ui-tinymce. I have to dig more into this. I logged the $render function, it was </p>

<div class="highlight"><pre><code class="javascript"><span class="nx">element</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">$isEmpty</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">$viewValue</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">$viewValue</span><span class="p">);</span>
</code></pre></div>
 

<p>I searched Angular&#39;s source code and found the definition of this function</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">function</span> <span class="nx">textInputType</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">,</span> <span class="nx">$sniffer</span><span class="p">,</span> <span class="nx">$browser</span><span class="p">)</span> <span class="p">{</span>
<span class="p">.....</span>
<span class="nx">ctrl</span><span class="p">.</span><span class="nx">$render</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">$isEmpty</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">$viewValue</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">$viewValue</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">}</span>
</code></pre></div>

<p>I added some log above it and witnessed that this definition is called after the counterpart in ui-tinymce. I then switched to rc2, verified the result is on the contrary. </p>

<p>It&#39;s now clear that the root cause of the issue is that the link function in ui-tinymce is called earlier in rc3. There must be more than one directive defined on the element, the order of the link function is controlled by the priority property. </p>

<h1>directive&#39;s priorty</h1>

<p>It occurs to me there&#39;s some change log in Angular rc3&#39;s <a href="https://github.com/angular/angular.js/blob/master/CHANGELOG.md">changelog</a> talking about the directive priority change.</p>

<blockquote>
<p>Previously the compile/link fns executed in this order controlled via priority:</p>

<ul>
<li>CompilePriorityHigh, CompilePriorityMedium, CompilePriorityLow</li>
<li>compile child nodes</li>
<li>PreLinkPriorityHigh, PreLinkPriorityMedium, PreLinkPriorityLow</li>
<li>link child nodes</li>
<li>PostLinkPriorityHigh, PostLinkPriorityMedium, PostLinkPriorityLow</li>
</ul>

<p>This was changed to:</p>

<ul>
<li>CompilePriorityHigh, CompilePriorityMedium, CompilePriorityLow</li>
<li>compile child nodes</li>
<li>PreLinkPriorityHigh, PreLinkPriorityMedium, PreLinkPriorityLow</li>
<li>link child nodes</li>
<li>PostLinkPriorityLow, PostLinkPriorityMedium , PostLinkPriorityHigh</li>
</ul>

<p>Very few directives in practice rely on order of postLinking function (unlike on the order of compile functions), so in the rare case of this change affecting an existing directive, it might be necessary to convert it to a preLinking function or give it negative priority (look at the diff of this commit to see how an internal attribute interpolation directive was adjusted).</p>
</blockquote>

<p>The first attempt is to find what is the priority of the ngModel directive. Searching through the source code, I didn&#39;t find any. With a safe guess, it would be 0 by default. I added the priority of 10 in ui-tinymce, the whole thing gets back to work again, I can see from the log our customized link function is called after the native one. </p>

<h1>The Mystery</h1>

<p>I can call it a day if I want because the issue is fixed. But I still leave some questions unsolved:</p>

<ul>
<li>I can&#39;t even name the directive by calling it &quot;the native one&quot;</li>
<li>Actually rc3 didn&#39;t change the priority related to this issue, both directives have default priority &quot;0&quot; in this case. Why the invoking order changes between rc2 and rc3?</li>
</ul>

<h2>directive under the hood</h2>

<p>There&#39;s some directive added by Angular implicitly during initialization, like <code>input</code>, <code>textarea</code>, <code>form</code>. Despite the name, it&#39;s actual an Angular directive. This is very important and may sound confusing when you first come to it. I think why Angular doesn&#39;t pre-define those directives as <code>ng-input</code>, <code>ng-textarea</code> is to leave user no choice but always stick to them. Otherwise if you don&#39;t want to use <code>ng-input</code>, youcan switch to <code>input</code> by simply use <code>input</code> tag. That being said, elements like <code>input</code>, <code>textarea</code> are always directives.
All the native Angular directive name actually goes with a directive, the rule is defined as below. </p>

<div class="highlight"><pre><code class="javascript"><span class="nx">angularModule</span><span class="p">(</span><span class="s1">&#39;ng&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;ngLocale&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;$provide&#39;</span><span class="p">,</span>
    <span class="kd">function</span> <span class="nx">ngModule</span><span class="p">(</span><span class="nx">$provide</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$provide</span><span class="p">.</span><span class="nx">provider</span><span class="p">(</span><span class="s1">&#39;$compile&#39;</span><span class="p">,</span> <span class="nx">$CompileProvider</span><span class="p">).</span>
        <span class="nx">directive</span><span class="p">({</span>
            <span class="nx">a</span><span class="o">:</span> <span class="nx">htmlAnchorDirective</span><span class="p">,</span>
            <span class="nx">input</span><span class="o">:</span> <span class="nx">inputDirective</span><span class="p">,</span>
            <span class="nx">textarea</span><span class="o">:</span> <span class="nx">inputDirective</span><span class="p">,</span>
            <span class="nx">form</span><span class="o">:</span> <span class="nx">formDirective</span><span class="p">,</span>
            <span class="nx">script</span><span class="o">:</span> <span class="nx">scriptDirective</span><span class="p">,</span>
            <span class="nx">select</span><span class="o">:</span> <span class="nx">selectDirective</span><span class="p">,</span>
            <span class="nx">style</span><span class="o">:</span> <span class="nx">styleDirective</span><span class="p">,</span>
            <span class="nx">option</span><span class="o">:</span> <span class="nx">optionDirective</span><span class="p">,</span>
            <span class="nx">ngBind</span><span class="o">:</span> <span class="nx">ngBindDirective</span><span class="p">,</span>
            <span class="nx">ngBindHtml</span><span class="o">:</span> <span class="nx">ngBindHtmlDirective</span><span class="p">,</span>
            <span class="nx">ngBindTemplate</span><span class="o">:</span> <span class="nx">ngBindTemplateDirective</span><span class="p">,</span>
            <span class="nx">ngClass</span><span class="o">:</span> <span class="nx">ngClassDirective</span><span class="p">,</span>
            <span class="nx">ngClassEven</span><span class="o">:</span> <span class="nx">ngClassEvenDirective</span><span class="p">,</span>
            <span class="nx">ngClassOdd</span><span class="o">:</span> <span class="nx">ngClassOddDirective</span><span class="p">,</span>
            <span class="nx">ngCsp</span><span class="o">:</span> <span class="nx">ngCspDirective</span><span class="p">,</span>
            <span class="nx">ngCloak</span><span class="o">:</span> <span class="nx">ngCloakDirective</span><span class="p">,</span>
            <span class="nx">ngController</span><span class="o">:</span> <span class="nx">ngControllerDirective</span><span class="p">,</span>
            <span class="nx">ngForm</span><span class="o">:</span> <span class="nx">ngFormDirective</span><span class="p">,</span>
            <span class="nx">ngHide</span><span class="o">:</span> <span class="nx">ngHideDirective</span><span class="p">,</span>
            <span class="nx">ngIf</span><span class="o">:</span> <span class="nx">ngIfDirective</span><span class="p">,</span>
            <span class="nx">ngInclude</span><span class="o">:</span> <span class="nx">ngIncludeDirective</span><span class="p">,</span>
            <span class="nx">ngInit</span><span class="o">:</span> <span class="nx">ngInitDirective</span><span class="p">,</span>
            <span class="nx">ngNonBindable</span><span class="o">:</span> <span class="nx">ngNonBindableDirective</span><span class="p">,</span>
            <span class="nx">ngPluralize</span><span class="o">:</span> <span class="nx">ngPluralizeDirective</span><span class="p">,</span>
            <span class="nx">ngRepeat</span><span class="o">:</span> <span class="nx">ngRepeatDirective</span><span class="p">,</span>
            <span class="nx">ngShow</span><span class="o">:</span> <span class="nx">ngShowDirective</span><span class="p">,</span>
            <span class="nx">ngStyle</span><span class="o">:</span> <span class="nx">ngStyleDirective</span><span class="p">,</span>
            <span class="nx">ngSwitch</span><span class="o">:</span> <span class="nx">ngSwitchDirective</span><span class="p">,</span>
            <span class="nx">ngSwitchWhen</span><span class="o">:</span> <span class="nx">ngSwitchWhenDirective</span><span class="p">,</span>
            <span class="nx">ngSwitchDefault</span><span class="o">:</span> <span class="nx">ngSwitchDefaultDirective</span><span class="p">,</span>
            <span class="nx">ngOptions</span><span class="o">:</span> <span class="nx">ngOptionsDirective</span><span class="p">,</span>
            <span class="nx">ngTransclude</span><span class="o">:</span> <span class="nx">ngTranscludeDirective</span><span class="p">,</span>
            <span class="nx">ngModel</span><span class="o">:</span> <span class="nx">ngModelDirective</span><span class="p">,</span>
            <span class="nx">ngList</span><span class="o">:</span> <span class="nx">ngListDirective</span><span class="p">,</span>
            <span class="nx">ngChange</span><span class="o">:</span> <span class="nx">ngChangeDirective</span><span class="p">,</span>
            <span class="nx">required</span><span class="o">:</span> <span class="nx">requiredDirective</span><span class="p">,</span>
            <span class="nx">ngRequired</span><span class="o">:</span> <span class="nx">requiredDirective</span><span class="p">,</span>
            <span class="nx">ngValue</span><span class="o">:</span> <span class="nx">ngValueDirective</span>
        <span class="p">}).</span>
        <span class="nx">directive</span><span class="p">(</span><span class="nx">ngAttributeAliasDirectives</span><span class="p">).</span>
        <span class="nx">directive</span><span class="p">(</span><span class="nx">ngEventDirectives</span><span class="p">);</span>
      <span class="nx">$provide</span><span class="p">.</span><span class="nx">provider</span><span class="p">({</span>
        <span class="nx">$anchorScroll</span><span class="o">:</span> <span class="nx">$AnchorScrollProvider</span><span class="p">,</span>
        <span class="nx">$animate</span><span class="o">:</span> <span class="nx">$AnimateProvider</span><span class="p">,</span>
        <span class="nx">$browser</span><span class="o">:</span> <span class="nx">$BrowserProvider</span><span class="p">,</span>
        <span class="nx">$cacheFactory</span><span class="o">:</span> <span class="nx">$CacheFactoryProvider</span><span class="p">,</span>
        <span class="nx">$controller</span><span class="o">:</span> <span class="nx">$ControllerProvider</span><span class="p">,</span>
        <span class="nx">$document</span><span class="o">:</span> <span class="nx">$DocumentProvider</span><span class="p">,</span>
        <span class="nx">$exceptionHandler</span><span class="o">:</span> <span class="nx">$ExceptionHandlerProvider</span><span class="p">,</span>
        <span class="nx">$filter</span><span class="o">:</span> <span class="nx">$FilterProvider</span><span class="p">,</span>
        <span class="nx">$interpolate</span><span class="o">:</span> <span class="nx">$InterpolateProvider</span><span class="p">,</span>
        <span class="nx">$interval</span><span class="o">:</span> <span class="nx">$IntervalProvider</span><span class="p">,</span>
        <span class="nx">$http</span><span class="o">:</span> <span class="nx">$HttpProvider</span><span class="p">,</span>
        <span class="nx">$httpBackend</span><span class="o">:</span> <span class="nx">$HttpBackendProvider</span><span class="p">,</span>
        <span class="nx">$location</span><span class="o">:</span> <span class="nx">$LocationProvider</span><span class="p">,</span>
        <span class="nx">$log</span><span class="o">:</span> <span class="nx">$LogProvider</span><span class="p">,</span>
        <span class="nx">$parse</span><span class="o">:</span> <span class="nx">$ParseProvider</span><span class="p">,</span>
        <span class="nx">$rootScope</span><span class="o">:</span> <span class="nx">$RootScopeProvider</span><span class="p">,</span>
        <span class="nx">$q</span><span class="o">:</span> <span class="nx">$QProvider</span><span class="p">,</span>
        <span class="nx">$sce</span><span class="o">:</span> <span class="nx">$SceProvider</span><span class="p">,</span>
        <span class="nx">$sceDelegate</span><span class="o">:</span> <span class="nx">$SceDelegateProvider</span><span class="p">,</span>
        <span class="nx">$sniffer</span><span class="o">:</span> <span class="nx">$SnifferProvider</span><span class="p">,</span>
        <span class="nx">$templateCache</span><span class="o">:</span> <span class="nx">$TemplateCacheProvider</span><span class="p">,</span>
        <span class="nx">$timeout</span><span class="o">:</span> <span class="nx">$TimeoutProvider</span><span class="p">,</span>
        <span class="nx">$window</span><span class="o">:</span> <span class="nx">$WindowProvider</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">]);</span>
<span class="p">}</span>
</code></pre></div>

<p>I&#39;d like to list them all because it helps me understand other stuff which I thought was magic before. During the compiling phase, Angular will go through the DOM and do the name-and-directive matching. Native directive will use beflow rule and customized one will use &quot;same name matching&quot;. rule. e.g. <code>data-ng-input</code> will be normalized into <code>input</code> and goes with <code>inputDirecive</code>. <code>data-ng-customized-div</code> will be normalized into <code>customizedDiv</code> and go with <code>customizedDiv</code> directive.</p>

<p>Let&#39;s get to the <code>inputDirecive</code>. </p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">inputDirective</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;$browser&#39;</span><span class="p">,</span> <span class="s1">&#39;$sniffer&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$browser</span><span class="p">,</span> <span class="nx">$sniffer</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">restrict</span><span class="o">:</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span>
    <span class="nx">require</span><span class="o">:</span> <span class="s1">&#39;?ngModel&#39;</span><span class="p">,</span>
    <span class="nx">link</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="nx">inputType</span><span class="p">[</span><span class="nx">lowercase</span><span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">type</span><span class="p">)]</span> <span class="o">||</span> <span class="nx">inputType</span><span class="p">.</span><span class="nx">text</span><span class="p">)(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">,</span> <span class="nx">$sniffer</span><span class="p">,</span>
                                                            <span class="nx">$browser</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}];</span>
</code></pre></div>

<p>In the <code>link</code> function, it will find the base link function it will use. We didn&#39;t specify any type in the textarea tag, so it will use &quot;text&quot; as the default.
&quot;text&quot; goes with <code>textInputType</code></p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">inputType</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;text&#39;</span><span class="o">:</span> <span class="nx">textInputType</span><span class="p">,</span>
<span class="s1">&#39;number&#39;</span><span class="o">:</span> <span class="nx">numberInputType</span><span class="p">,</span>
<span class="p">....</span>
<span class="p">}</span>
</code></pre></div>

<h2>textInputType</h2>

<p>What is <code>textInputType</code>? It&#39;s a link function for all input elements. It adds 
* some common functions on ngModel controller 
* some event listener. It also addes validation. It also provide a default implementation for some <code>noop</code> function defined in ngModelController. <code>$render</code> is one of it. But you can override it in your link, like ui-tinymce does.
In our case, there&#39;re actually 3 directives bound to <code>textarea</code>, let&#39;s take a close look at them. &#39;textarea&#39; is the implicit directive which has textInputType as its link function.</p>

<div class="highlight"><pre><code class="javascript"><span class="p">{</span>
<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;textarea&#39;</span><span class="p">,</span>
<span class="nx">index</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="nx">priority</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="nx">require</span><span class="o">:</span> <span class="s1">&#39;?ngModel&#39;</span><span class="p">,</span>
<span class="nx">restrict</span><span class="o">:</span> <span class="s2">&quot;E&quot;</span>
<span class="p">}</span>

<span class="p">{</span>
<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;uiTinymce&#39;</span><span class="p">,</span>
<span class="nx">index</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="nx">priority</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
<span class="nx">require</span><span class="o">:</span> <span class="s1">&#39;ngModel&#39;</span>
<span class="nx">restrict</span><span class="o">:</span> <span class="s2">&quot;A&quot;</span>
<span class="p">}</span>


<span class="p">{</span>
<span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;ngModel&quot;</span><span class="p">,</span>
<span class="nx">index</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="nx">priority</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="nx">require</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;^ngModel&quot;</span><span class="p">,</span> <span class="s2">&quot;^?form&quot;</span><span class="p">},</span>
<span class="nx">restrict</span><span class="o">:</span> <span class="s2">&quot;A&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p>If 2 directives on the same element both override the same function on ngModelController, how does Angular determine the order? well, Let&#39;s look at this.</p>

<div class="highlight"><pre><code class="javascript"> <span class="kd">function</span> <span class="nx">collectDirectives</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">directives</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">maxPriority</span><span class="p">,</span> <span class="nx">ignoreDirective</span><span class="p">)</span> <span class="p">{</span>
 <span class="p">......</span>
    <span class="nx">directives</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">byPriority</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">directives</span><span class="p">;</span>
 
 <span class="p">}</span>
</code></pre></div>

<p>It&#39;s the sort function <code>byPriority</code> that makes the call and <code>priority</code> plays an important role. rc3 and rc2 are totally different. In rc3, it will compare the name and index if priorty is the same. </p>

<div class="highlight"><pre><code class="javascript"><span class="c1">// rc3</span>
<span class="kd">function</span> <span class="nx">byPriority</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">diff</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">priority</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">priority</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">diff</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">diff</span><span class="p">;</span>
  <span class="c1">//IW: larger name has a lower order, different from priority comparison</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">name</span> <span class="o">!==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">name</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">index</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//rc2</span>
<span class="kd">function</span> <span class="nx">byPriority</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">priority</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">priority</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>In our case, because <code>uiTinymce</code> is larger than <code>textarea</code> in string comparison, in contrast, it has a lower priority than <code>textarea</code>. According to the rule, lower priority directive is post-linked before higher one, so that&#39;s why our $render is always overriden by the default one.</p>

<p>The original order is [<code>textarea</code>, <code>uiTinymce</code>, <code>ngModel</code>]. In rc2, because lower priority directive will be post-linked after higher one, <code>uiTinymce</code> is linked after <code>textarea</code>. I&#39;m going to take a look at how Angular gets these directives. But now, I&#39;m going to call it a day.</p>

</div>


            <div class="footer">
              <div class="contact">
                 <p>
                  Ivan<br />
                  Shanghai, CHINA<br />
                  ivan.wang2010@gmail.com
                </p>
              </div>
              <!-- <div class="contact">
                <p>
                  <a href="http://github.com/yourusername/">github.com/yourusername</a><br />
                  <a href="http://twitter.com/yourusername/">twitter.com/yourusername</a><br />
                </p>
              </div> -->
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
